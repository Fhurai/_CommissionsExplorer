function getStats(){fetch("http://naslku.synology.me/Commissions/api/stats.php").then(e=>e.json()).then(e=>{generatePanels(e),document.body.innerHTML+="<hr>",generateArtistsTable(e)}).catch(e=>console.error("Failed to check stats:",e.message)).finally(()=>console.debug("Stats checked."))}function generatePanels(e){generatePanel({id:"Total",sections:[createToggleSection("Artistes",e,"artists"),createToggleSection("Commissions",e,"commissions"),createImageRatioSection(e),]}),generatePanel({id:"SFW",sections:[createStatItem("Artistes",e.sfw.artists.count),createStatItem("Commissions",e.sfw.commissions.count),createImageSubsection(e.sfw,"sfw"),]}),generatePanel({id:"NSFW",sections:[createStatItem("Artistes",e.nsfw.artists.count),createStatItem("Commissions",e.nsfw.commissions.count),createImageSubsection(e.nsfw,"nsfw"),]})}function generatePanel(e){let t=document.createElement("div");t.className="panel",t.id=e.id,e.sections.forEach(e=>{let a=createContainer();a.appendChild(e),t.appendChild(a)}),document.body.appendChild(t)}function generateArtistsTable(e){generateTable(e.sfw,"sfw");let t=document.createElement("hr");document.body.appendChild(t),generateTable(e.nsfw,"nsfw")}function generateTable(e,t){let a=document.createElement("div");a.classList="table-container",document.body.appendChild(a);let n=document.createElement("table");n.className="table",n.id=t,a.appendChild(n);let s=document.createElement("thead");n.appendChild(s);let i=document.createElement("tr");s.appendChild(i);let r=document.createElement("tr");s.appendChild(r),["Artist","# Commissions","% Total","# Pictures","Ratio P / C"].forEach((e,a)=>{let n=document.createElement("th");n.textContent=e,n.addEventListener("click",clickHeader),i.appendChild(n);let s=document.createElement("td"),c=document.createElement("input");c.type=0===a?"text":"number",0!==a&&(c.step=[1,3].includes(a)?1:.01,c.min=0),c.placeholder=e,c.className="search",c.id="search"+t.replace(" ","").trim()+e.replace(" ","").trim(),c.name=e,c.addEventListener("input",searchColumn),s.appendChild(c),r.appendChild(s)});let c=document.createElement("tbody");n.appendChild(c),Object.entries(e.artists.details).forEach(([t,a])=>{let n=Object.entries(e.commissions.details)[t][1],s=Object.entries(e.thumbnails.details)[t][1],i=document.createElement("tr");i.classList=t%2?"even":"odd",i.innerHTML=`
            <td>${a}</td>
            <td>${n}</td>
            <td>${calculatePercentage(n,totalCommissions)}%</td>
            <td>${s}</td>
            <td>${calculatePercentage(s,n)}%</td>`,c.appendChild(i)})}function searchColumn(e){let t=e.currentTarget.parentElement,a=Array.from(t.parentElement.children).findIndex(e=>e===t),n=e.currentTarget.value.trim().toLowerCase();t.closest("table").querySelectorAll("tbody tr").forEach(e=>{let t=0===a?e.querySelector(`td:nth-child(${a+1})`).innerText.trim().substring(0,n.length).toLowerCase():e.querySelector(`td:nth-child(${a+1})`).innerText.trim().toLowerCase(),s;if(s=void 0!==e.dataset.hidden?JSON.parse(e.dataset.hidden):[],t.includes(n)||""===n){let i=s.indexOf(a);i>-1&&s.splice(i,1)}else s.includes(a)||s.push(a);e.dataset.hidden=JSON.stringify(s)}),hideRow()}function hideRow(){document.querySelectorAll("table tbody tr").forEach(e=>{if(void 0!==e.dataset.hidden){let t=JSON.parse(e.dataset.hidden);t.length>0?e.setAttribute("hidden","hidden"):e.removeAttribute("hidden")}})}function clickHeader(e){let t=e.currentTarget.closest("table"),a=t.id,n=e.currentTarget,s=Array.from(n.parentElement.children).indexOf(n),i=sortStates[a],r=i.order.findIndex(e=>e.column===s);if(-1===r)i.order.push({column:s,direction:"asc"}),n.dataset.order="▲";else{let c=i.order[r].direction;"asc"===c?(i.order[r].direction="desc",n.dataset.order="▼"):(i.order.splice(r,1),delete n.dataset.order,delete n.dataset.position)}updateSortIndicators(t),sortTable(t)}function updateSortIndicators(e){let t=sortStates[e.id],a=e.querySelectorAll("th");a.forEach((e,a)=>{let n=t.order.findIndex(e=>e.column===a);n>-1?e.dataset.position=n+1:delete e.dataset.position})}function sortTable(e){let t=sortStates[e.id],a=e.querySelector("tbody"),n=Array.from(a.querySelectorAll("tr"));n.sort((e,a)=>{if(Object.entries(t.order).length>0)for(let n of t.order){let s=n.column,i="asc"===n.direction?1:-1,r=e.cells[s],c=a.cells[s],l=parseValue(r.textContent,0===s),o=parseValue(c.textContent,0===s);if(l!==o)return l>o?i:-i}else{let d=e.cells[0],u=a.cells[0],m=parseValue(d.textContent,!0),h=parseValue(u.textContent,!0);if(m!==h)return m>h?1:-1}return 0}),a.innerHTML="",n.forEach(e=>a.appendChild(e))}function parseValue(e,t){let a=Number(e.replace(/[^0-9.-]/g,""));return isNaN(a)||t?e.toLowerCase():a}function createToggleSection(e,t,a){let n=t.sfw[a].count+t.nsfw[a].count;"commissions"===a&&(totalCommissions=n);let s=calculatePercentage(t.sfw[a].count,n),i=document.createElement("div");return i.innerHTML=`
        <input type="checkbox" id="checkbox-${e}">
        <label class="stat" for="checkbox-${e}">
            ${e}: ${n}
        </label>
        <div class="stat-container">
            <div class="pie-chart" id="ratio-${a.toLowerCase()}" 
                 style="--ratio-var: ${s}%"></div>
            <div class="values">
                <div class="sfw">sfw: ${s}%</div>
                <div class="nsfw">nsfw: ${100-s}%</div>
            </div>
        </div>
    `,i}function createImageSubsection(e,t){let a=e.thumbnails.count,n=e.commissions.count-a,s=calculatePercentage(a,e.commissions.count),i=document.createElement("div");return i.innerHTML=`
        <input type="checkbox" id="checkbox-images-${t}">
        <label class="stat" for="checkbox-images-${t}">
            Images: ${a} - Others: ${n}
        </label>
        <div class="stat-container">
            <div class="pie-chart" id="ratio-images-${t}" 
                 style="--ratio-var: ${s}%"></div>
            <div class="values">
                <div class="sfw">pictures: ${s}%</div>
                <div class="nsfw">others: ${calculatePercentage(n,e.commissions.count)}%</div>
            </div>
        </div>
    `,i}function createImageRatioSection(e){let t=e.sfw.thumbnails.count+e.nsfw.thumbnails.count,a=e.sfw.commissions.count+e.nsfw.commissions.count,n=calculatePercentage(t,a),s=document.createElement("div");return s.innerHTML=`
        <input type="checkbox" id="checkbox-images-total">
        <label class="stat" for="checkbox-images-total">
            Images: ${t} - Others: ${a-t}
        </label>
        <div class="stat-container">
            <div class="pie-chart" id="ratio-images" 
                 style="--ratio-var: ${n}%"></div>
            <div class="values">
                <div class="sfw">pictures: ${n}%</div>
                <div class="nsfw">others: ${Math.round((100-n+Number.EPSILON)*100)/100}%</div>
            </div>
        </div>
    `,s}function createContainer(){let e=document.createElement("div");return e.className="container",e}function createStatItem(e,t){let a=document.createElement("div");return a.className="stat",a.textContent=`${e}: ${t}`,a}function calculatePercentage(e,t){return 0===t?0:Math.round(e/t*1e4)/100}document.addEventListener("DOMContentLoaded",()=>getStats());